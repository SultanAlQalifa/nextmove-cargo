-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ›¡ï¸ IRON DOME: VISUAL SECURITY REPORT
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- This script returns a real TABLE of results so you can see them clearly.
BEGIN;
-- 1. Setup Result Table
CREATE TEMP TABLE security_report (
    test_name TEXT,
    result TEXT,
    details TEXT
) ON COMMIT DROP;
DO $$
DECLARE v_user_id UUID := gen_random_uuid();
v_wallet_id UUID := gen_random_uuid();
v_coupon_id UUID;
BEGIN -- 0. Temporary User Helper
BEGIN
INSERT INTO auth.users (id, email)
VALUES (v_user_id, 'test_visual@temp.com');
INSERT INTO profiles (id, email, role, full_name)
VALUES (
        v_user_id,
        'test_visual@temp.com',
        'client',
        'Security Test'
    );
EXCEPTION
WHEN OTHERS THEN NULL;
-- Continue if exists
END;
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- TEST 1: WALLET INTEGRITY
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INSERT INTO wallets (id, user_id, balance, currency)
VALUES (v_wallet_id, v_user_id, 0, 'XOF');
BEGIN
UPDATE wallets
SET balance = -5000
WHERE id = v_wallet_id;
INSERT INTO security_report
VALUES (
        'Wallet Negative Balance',
        'âŒ FAIL',
        'Database allowed negative debt'
    );
EXCEPTION
WHEN check_violation THEN
INSERT INTO security_report
VALUES (
        'Wallet Integrity',
        'âœ… PASS',
        'Database blocked negative balance (-5000 XOF)'
    );
END;
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- TEST 2: COUPON FRAUD
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INSERT INTO coupons (
        code,
        discount_type,
        discount_value,
        start_date,
        end_date,
        is_active
    )
VALUES (
        'VISUAL-TEST-' || substring(v_user_id::text, 1, 5),
        'percentage',
        10,
        NOW() - INTERVAL '2d',
        NOW() - INTERVAL '1d',
        true
    )
RETURNING id INTO v_coupon_id;
BEGIN
INSERT INTO coupon_usages (coupon_id, user_id)
VALUES (v_coupon_id, v_user_id);
INSERT INTO security_report
VALUES (
        'Coupon Expiry',
        'âŒ FAIL',
        'Expired coupon was accepted'
    );
EXCEPTION
WHEN raise_exception THEN
INSERT INTO security_report
VALUES (
        'Coupon Security',
        'âœ… PASS',
        'Expired coupon usage was rejected'
    );
END;
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- TEST 3: MALWARE UPLOAD
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
IF EXISTS (
    SELECT 1
    FROM storage.buckets
    WHERE id = 'avatars'
        AND 'application/x-msdownload' = ANY(allowed_mime_types)
) THEN
INSERT INTO security_report
VALUES (
        'Storage Security',
        'âŒ FAIL',
        'Avatars bucket accepts .exe files'
    );
ELSE
INSERT INTO security_report
VALUES (
        'Storage Security',
        'âœ… PASS',
        'Avatars bucket forces safe MIME types'
    );
END IF;
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- TEST 4: AUDIT LOGS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
IF EXISTS (
    SELECT 1
    FROM information_schema.tables
    WHERE table_name = 'audit_logs'
) THEN
INSERT INTO security_report
VALUES (
        'Audit System',
        'âœ… PASS',
        'Audit Logs table is active and monitoring'
    );
ELSE
INSERT INTO security_report
VALUES (
        'Audit System',
        'âŒ FAIL',
        'Audit Logs table not found'
    );
END IF;
-- CLEANUP
DELETE FROM wallets
WHERE id = v_wallet_id;
DELETE FROM coupons
WHERE id = v_coupon_id;
DELETE FROM profiles
WHERE id = v_user_id;
DELETE FROM auth.users
WHERE id = v_user_id;
END $$;
-- 2. SHOW RESULTS
SELECT *
FROM security_report;
COMMIT;