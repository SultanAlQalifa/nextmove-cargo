```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ›¡ï¸ IRON DOME: SELF-DIAGNOSTIC PENETRATION TEST
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Run this script in the Supabase SQL Editor.
-- It attempts to exploit the system. If the system defends itself, the test PASSES.
DO $$
DECLARE
    v_test_count INTEGER := 0;
    v_success_count INTEGER := 0;
    v_user_id UUID := gen_random_uuid(); -- Dummy User ID
    v_wallet_id UUID := gen_random_uuid();
    v_coupon_id UUID;
BEGIN
    RAISE NOTICE 'âš¡ STARTING SECURITY SCAN...';
    RAISE NOTICE '------------------------------------------------';

    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- SETUP: Create Dummy User for Integrity Tests
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- We need a valid user to attach a wallet to.
    -- Attempting to insert into auth.users (requires postgres role usually)
    -- If this fails due to permissions, we'll try to use a random ID and hope profiles doesn't strict check auth.users in this env,
    -- or we catch the error.
    
    BEGIN
        INSERT INTO auth.users (id, email, raw_user_meta_data) 
        VALUES (v_user_id, 'security_test@temp.com', '{"full_name": "Security Test"}'::jsonb);
        
        INSERT INTO profiles (id, email, role, full_name)
        VALUES (v_user_id, 'security_test@temp.com', 'client', 'Security Test')
        ON CONFLICT (id) DO NOTHING;
    EXCEPTION WHEN OTHERS THEN
        RAISE NOTICE 'âš ï¸ Could not create auth.user (Permissions?). Trying to proceed with just Profile...';
        -- Try inserting just profile, might fail if FK exists
        BEGIN
             INSERT INTO profiles (id, email, role, full_name)
             VALUES (v_user_id, 'security_test@temp.com', 'client', 'Security Test');
        EXCEPTION WHEN OTHERS THEN
             RAISE EXCEPTION 'CRITICAL: Cannot create dummy user for test. Constraint: %', SQLERRM;
        END;
    END;

    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- TEST 1: INTEGRITY ATTACK (Negative Wallet Balance)
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    v_test_count := v_test_count + 1;
    
    -- Create a dummy wallet for testing
    INSERT INTO wallets (id, user_id, balance, currency) 
    VALUES (v_wallet_id, v_user_id, 0, 'XOF');
    
    BEGIN
        -- ATTACK: Try to force negative balance
        UPDATE wallets SET balance = -5000 WHERE id = v_wallet_id;
        
        -- If we get here, the attack SUCCEEDED (Bad!)
        RAISE WARNING 'âŒ FAIL: Wallet allowed negative balance via SQL!';
    EXCEPTION WHEN check_violation THEN
        -- Integrity Error caught (Good!)
        v_success_count := v_success_count + 1;
        RAISE NOTICE 'âœ… PASS: Wallet blocked negative balance (Constraint Active).';
    END;

    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- TEST 2: FRAUD ATTACK (Expired Coupon Usage)
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    v_test_count := v_test_count + 1;

    -- Create a dummy expired coupon
    INSERT INTO coupons (code, discount_type, discount_value, start_date, end_date, is_active) 
    VALUES ('TEST-HACK-'||substring(v_user_id::text, 1, 8), 'percentage', 10, NOW() - INTERVAL '2 days', NOW() - INTERVAL '1 day', true) 
    RETURNING id INTO v_coupon_id;

    BEGIN
        -- ATTACK: Try to use expired coupon
        INSERT INTO coupon_usages (coupon_id, user_id) VALUES (v_coupon_id, v_user_id);
        
        -- If we get here, attack SUCCEEDED
        RAISE WARNING 'âŒ FAIL: System allowed usage of expired coupon!';
    EXCEPTION WHEN raise_exception THEN
        -- Trigger caught it (Good!)
        v_success_count := v_success_count + 1;
        RAISE NOTICE 'âœ… PASS: Coupon usage blocked (Expired Logic Active).';
    END;

    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- TEST 3: INFRASTRUCTURE SCAN (Storage MIME Types)
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    v_test_count := v_test_count + 1;

    -- Check if 'avatars' bucket has restricted MIME types
    IF EXISTS (
        SELECT 1 FROM storage.buckets 
        WHERE id = 'avatars' 
        AND 'application/x-msdownload' = ANY(allowed_mime_types) -- Check for .exe
    ) THEN
        RAISE WARNING 'âŒ FAIL: Avatars bucket accepts executables!';
    ELSE
        v_success_count := v_success_count + 1;
        RAISE NOTICE 'âœ… PASS: Avatars bucket MIME types are restricted.';
    END IF;

    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- TEST 4: FORENSICS CHECK (Audit Log Existence)
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    v_test_count := v_test_count + 1;

    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'audit_logs') THEN
        v_success_count := v_success_count + 1;
        RAISE NOTICE 'âœ… PASS: Audit Logs system is installed.';
    ELSE
        RAISE WARNING 'âŒ FAIL: Audit Logs table missing!';
    END IF;

    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- CLEANUP
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    DELETE FROM wallets WHERE id = v_wallet_id;
    DELETE FROM coupons WHERE id = v_coupon_id;
    DELETE FROM profiles WHERE id = v_user_id;
    DELETE FROM auth.users WHERE id = v_user_id; -- Cleanup auth user too if possible

    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- SUMMARY
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    RAISE NOTICE '------------------------------------------------';
    RAISE NOTICE 'ğŸ SCAN COMPLETE: % / % Checks Passed.', v_success_count, v_test_count;
    
    IF v_success_count = v_test_count THEN
        RAISE NOTICE 'ğŸ›¡ï¸ SYSTEM STATUS: SECURE';
    ELSE
        RAISE WARNING 'âš ï¸ SYSTEM STATUS: VULNERABLE';
    END IF;

END $$;
```